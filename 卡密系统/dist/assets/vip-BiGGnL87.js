import{aE as O,r as N,P as V,l as P}from"./index-ihp2IIuf.js";const D=O("vip",()=>{const p=N(!1),m=V({普通:{name:"普通用户",level:0,icon:"user",color:"#909399",benefits:["基础功能使用","标准客服支持"],discount:0},VIP:{name:"VIP会员",level:1,icon:"crown",color:"#f39c12",benefits:["享受所有基础功能","9.5折优惠购买卡密","优先客服支持","专属VIP标识"],discount:.05},SVIP:{name:"SVIP超级会员",level:2,icon:"diamond",color:"#9b59b6",benefits:["享受所有VIP功能","9折优惠购买卡密","专属客服通道","每月免费赠送卡密","独享SVIP标识","优先获得新功能体验"],discount:.1}}),o=V({VIP:{monthly:{name:"VIP月卡",duration:30,originalPrice:19.9,currentPrice:19.9,description:"30天VIP会员权益"},quarterly:{name:"VIP季卡",duration:90,originalPrice:49.9,currentPrice:49.9,description:"90天VIP会员权益，更优惠"},yearly:{name:"VIP年卡",duration:365,originalPrice:168,currentPrice:168,description:"365天VIP会员权益，最划算"}},SVIP:{monthly:{name:"SVIP月卡",duration:30,originalPrice:39.9,currentPrice:39.9,description:"30天SVIP超级会员权益"},quarterly:{name:"SVIP季卡",duration:90,originalPrice:99.9,currentPrice:99.9,description:"90天SVIP超级会员权益"},yearly:{name:"SVIP年卡",duration:365,originalPrice:328,currentPrice:328,description:"365天SVIP超级会员权益，尊享特权"}}}),g=r=>m[r]||m.普通,h=(r,n="普通")=>{const e=g(n),t=r*e.discount,s=r-t;return{originalPrice:parseFloat(r.toFixed(2)),discount:e.discount,discountAmount:parseFloat(t.toFixed(2)),finalPrice:parseFloat(s.toFixed(2)),savings:parseFloat(t.toFixed(2))}},U=async(r,n,e)=>{try{p.value=!0;const t=P(),s=t.user;if(!s)return{success:!1,message:"请先登录"};const i=o[r][n];if(!i)return{success:!1,message:"套餐不存在"};const c=i.currentPrice;if(e==="balance"&&t.getUserBalance(s.id)<c)return{success:!1,message:"余额不足，请充值后再试"};const a={id:Date.now(),orderNumber:`VIP${Date.now().toString().slice(-8)}`,userId:s.id,username:s.username,vipType:r,packageType:n,packageName:i.name,duration:i.duration,amount:c,paymentMethod:e,status:"pending",createTime:new Date().toLocaleString("zh-CN")},l=JSON.parse(localStorage.getItem("vip_orders")||"[]");return l.unshift(a),localStorage.setItem("vip_orders",JSON.stringify(l)),e==="balance"?await d(a.id,e):{success:!0,message:"VIP订单创建成功，请完成支付",data:a}}catch(t){return{success:!1,message:t.message||"购买失败"}}finally{p.value=!1}},d=async(r,n)=>{try{const e=JSON.parse(localStorage.getItem("vip_orders")||"[]"),t=e.findIndex(u=>u.id===r);if(t===-1)return{success:!1,message:"订单不存在"};const s=e[t],i=P(),c=i.user,a=await i.deductBalance(c.id,s.amount,`购买${s.packageName}`);if(!a.success)return a;const l=await f(c.id,s.vipType,s.duration);return l.success?(s.status="completed",s.paymentTime=new Date().toLocaleString("zh-CN"),s.completedTime=s.paymentTime,e[t]=s,localStorage.setItem("vip_orders",JSON.stringify(e)),i.refreshCurrentUser(),{success:!0,message:`恭喜您成功开通${s.packageName}！`,data:s}):l}catch(e){return{success:!1,message:e.message||"支付处理失败"}}},f=async(r,n,e)=>{try{const t=JSON.parse(localStorage.getItem("all_users")||"[]"),s=t.findIndex(u=>String(u.id)===String(r));if(s===-1)return{success:!1,message:"用户不存在"};const i=t[s],c=new Date;let a;i.vipExpireTime&&new Date(i.vipExpireTime)>c?a=new Date(i.vipExpireTime):a=new Date(c),a.setDate(a.getDate()+e),i.level=n,i.vipExpireTime=a.toISOString(),i.vipUpgradeTime=c.toLocaleString("zh-CN"),t[s]=i,localStorage.setItem("all_users",JSON.stringify(t));const l=JSON.parse(localStorage.getItem("vip_history")||"[]");return l.push({id:Date.now(),userId:r,username:i.username,fromLevel:i.level,toLevel:n,duration:e,expireTime:a.toISOString(),upgradeTime:c.toLocaleString("zh-CN"),operatorType:"user"}),localStorage.setItem("vip_history",JSON.stringify(l)),{success:!0,message:"VIP等级升级成功"}}catch(t){return{success:!1,message:t.message||"VIP升级失败"}}},S=r=>{try{const n=JSON.parse(localStorage.getItem("all_users")||"[]"),e=n.find(i=>String(i.id)===String(r));if(!e)return{isValid:!1,level:"普通",expireTime:null};const t=new Date,s=e.vipExpireTime?new Date(e.vipExpireTime):null;if(!s||s<=t){if(e.level!=="普通"){const i=n.findIndex(c=>String(c.id)===String(r));i!==-1&&(n[i].level="普通",localStorage.setItem("all_users",JSON.stringify(n)))}return{isValid:!1,level:"普通",expireTime:null}}return{isValid:!0,level:e.level,expireTime:s.toISOString(),daysRemaining:Math.ceil((s-t)/(1e3*60*60*24))}}catch{return{isValid:!1,level:"普通",expireTime:null}}},v=(r=null)=>{try{const n=JSON.parse(localStorage.getItem("vip_orders")||"[]");return r?n.filter(e=>String(e.userId)===String(r)):n}catch{return[]}},y=(r,n,e)=>{try{return o[r]&&o[r][n]?(o[r][n].currentPrice=parseFloat(e),localStorage.setItem("vip_pricing",JSON.stringify(o)),{success:!0,message:"价格更新成功"}):{success:!1,message:"套餐不存在"}}catch{return{success:!1,message:"价格更新失败"}}},I=()=>{try{const r=localStorage.getItem("vip_pricing");if(r){const n=JSON.parse(r);Object.assign(o,n)}else localStorage.setItem("vip_pricing",JSON.stringify(o))}catch(r){console.error("初始化VIP价格配置失败:",r)}},x=()=>{try{const r=JSON.parse(localStorage.getItem("all_users")||"[]"),n=new Date,e={totalUsers:r.length,normalUsers:0,vipUsers:0,svipUsers:0,activeVipUsers:0,expiredVipUsers:0,thisMonthRevenue:0,totalRevenue:0};r.forEach(c=>{const a=S(c.id);a.level==="VIP"?a.isValid?(e.vipUsers++,e.activeVipUsers++):(e.expiredVipUsers++,e.normalUsers++):a.level==="SVIP"?a.isValid?(e.svipUsers++,e.activeVipUsers++):(e.expiredVipUsers++,e.normalUsers++):e.normalUsers++});const t=v(),s=new Date().getMonth(),i=new Date().getFullYear();return t.forEach(c=>{if(c.status==="completed"){e.totalRevenue+=c.amount;const a=new Date(c.completedTime);a.getMonth()===s&&a.getFullYear()===i&&(e.thisMonthRevenue+=c.amount)}}),e}catch{return{totalUsers:0,normalUsers:0,vipUsers:0,svipUsers:0,activeVipUsers:0,expiredVipUsers:0,thisMonthRevenue:0,totalRevenue:0}}};return I(),{loading:p,vipLevels:m,vipPackages:o,getUserVipInfo:g,calculateDiscountPrice:h,purchaseVip:U,processVipPayment:d,upgradeUserVip:f,checkUserVipStatus:S,getVipOrders:v,updateVipPricing:y,initializePricing:I,getVipStats:x}});export{D as useVipStore};
